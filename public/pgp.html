<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="/favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PGP</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <link href="/css/style.css" rel="stylesheet" type="text/css" media="all">
  <script src="/js/kbpgp-2.0.8-min.js"></script>
</head>

<body>
<noscript>
	<h3 style="background:red;color:white;text-align:center;">
		This site works best with <a style="color:white;" href="http://www.enable-javascript.com/" target="_blanc">JavaScript enabled</a>
	</h3>
</noscript>

<p>keybase pgp</p>

	<div style="color: red;" id="debug"></div>
	<div id="info">
		<label>Username:</label>
		<input type="text" id="username" value=""/>
		<label>Full name:</label>
		<input type="text" id="fullname" value=""/>
		<label>Email:</label>
		<input type="text" id="email" value=""/>
		<label>Password:</label>
		<input type="password" id="password" value=""/>
	</div>
	<div id="keys" style="display:none;">
		<label>Public key:</label>
		<a id="publicKeyUrl" href="#" style="display:none;" download="public.key">Download public key</a>
		<textarea id="publicKey">Please wait...</textarea>
		<label>Private key:</label>
		<a id="privateKeyUrl" href="#" style="display:none;" download="private.key">Download private key</a>
		<textarea id="privateKey">Please wait...</textarea>
	</div>
	<div>
		<button id="generate" onclick="gen()">Generate</button>
	</div>

<script>
// create keys
var dbg = document.getElementById('debug');
function trace(v)
{
	var t = null;
	if (typeof v === "string") t = v;
	else t = JSON.stringify(v);
	if (t !== null) dbg.innerHTML = t;
}

function gen(){
	var empty = "Empty ", a = [];
	var username = document.getElementById('username');
	var fullname = document.getElementById('fullname');
	var email = document.getElementById('email');
	var password = document.getElementById('password');
	if (!$('#username').val()) a.push("username");
	if (!$('#fullname').val()) a.push("fullname");
	if (!$('#email').val()) a.push("email");
	if (!$('#password').val()) a.push("password");
	if (a.length > 0){
		trace(empty + a.join(", ") + "!");
		return;
	}
	var user = fullname.value + " (" + username.value + ") <" + email.value + ">";
	var pass = password.value; //console.log(user ,pass);
	trace('');
	$('#info').hide();
	$('#keys').show();
	generatePgpKeys(user,pass);
	$("#generate").prop("disabled",true);
}

function generatePgpKeys(user,password){
	kbpgp.KeyManager.generate_ecc({ userid : user }, function(err, userKM) {
	  if (!err) {
		userKM.sign({}, function(err) {
//		  console.log(userKM);
		  userKM.export_pgp_private ({
			passphrase: password
		  }, function(err, pgp_private) {
			$("#privateKey").val(pgp_private);
			download('privateKeyUrl',pgp_private);
			localStorage.setItem(user+'-privateKey',pgp_private);
		  });
		  userKM.export_pgp_public({}, function(err, pgp_public) {
			$("#publicKey").val(pgp_public);
			download('publicKeyUrl',pgp_public);
			localStorage.setItem(user+'-publicKey',pgp_public);
		  });
		});
	  }else{
		  trace(err);	
	  }
	});
	function download(link,key){
		var blob = new window.Blob([key], {type: "application/pgp-keys"}); 
		var urlCreator = window.URL || window.webkitURL;
		var fileUrl = urlCreator.createObjectURL(blob);
		var id = '#'+link;
		$(id).attr("href", fileUrl);
		$(id).show();
	};
}
</script>

</body>
</html>
